{% extends "base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
{% endblock %}

{% block title %}Checkout | Bloom and Brew{% endblock %}
{% block meta_description %}Secure checkout for your Bloom & Brew order. Review your cart and complete your purchase with ease.{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="mb-4 text-center">Checkout</h2>

  <!-- Main checkout form -->
  <form method="post" id="payment-form">
    {% csrf_token %}
    {{ form|crispy }}
    <input type="hidden" name="stripe_pid" value="{{ stripe_pid }}">

    <!-- Order Summary -->
    <div class="mb-4 mt-3">
      <h4 class="mb-3">Order Summary</h4>
      <ul class="list-group">
        <li class="list-group-item d-flex justify-content-between">
          <span>Subtotal</span>
          <strong>€{{ cart_total|floatformat:2 }}</strong>
        </li>
        <li class="list-group-item d-flex justify-content-between">
          <span>Delivery</span>
          <strong>€{{ delivery_fee|floatformat:2 }}</strong>
        </li>

        {# Only show these when a promo is applied #}
        {% if applied_promo %}
          <li class="list-group-item d-flex justify-content-between">
            <span>Total before discount</span>
            <strong>€{{ total_before_discount|floatformat:2 }}</strong>
          </li>

          {% if discount_amount and discount_amount|floatformat:2 != "0.00" %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <span class="text-success">Promo discount</span>
                <span class="badge text-bg-success ms-2">
                  {{ applied_promo.code|upper }} ({{ applied_promo.percent_off|floatformat:0 }}%)
                </span>
              </div>
              <strong class="text-success">-€{{ discount_amount|floatformat:2 }}</strong>
            </li>
          {% endif %}
        {% endif %}

        <li class="list-group-item d-flex justify-content-between">
          <span><strong>Total to pay</strong></span>
          <strong>€{{ total_due|floatformat:2 }}</strong>
        </li>
      </ul>

      <!-- Promo code input -->
      <div class="mt-3 d-flex gap-2 align-items-start">
        <input
          type="text"
          id="promo-code-input"
          class="form-control"
          placeholder="Enter promo code"
          aria-label="Promo code"
        >
        <button
          class="btn btn-primary"
          type="button"
          id="apply-promo-btn"
          data-apply-url="{% url 'apply_promo' %}"
        >
          Apply
        </button>
        {% if applied_promo %}
          <button
            class="btn btn-outline-secondary"
            type="button"
            id="clear-promo-btn"
            data-clear-url="{% url 'clear_promo' %}"
          >
            Remove
          </button>
        {% endif %}
      </div>
      <p class="small mt-2 text-muted" id="promo-help">
        {% if applied_promo %}
          Promo applied. You can remove it to restore the original total.
        {% else %}
          Have a promo code? Enter it above and click Apply.
        {% endif %}
      </p>
    </div>

    <!-- Card field (Stripe) -->
    <div class="mb-3">
      <label class="form-label">Card Details</label>
      <div id="card-element" class="StripeElement"></div>
      <div id="card-errors" class="text-danger mt-2" role="alert"></div>
    </div>

    <button type="submit" class="btn btn-primary mt-3" aria-label="Submit payment for your order">
      Place Order and Pay €{{ total_due|floatformat:2 }}
    </button>
  </form>

  {# Hidden POST forms must be OUTSIDE the main form (no nested forms) #}
  <form id="apply-promo-form" method="post" action="{% url 'apply_promo' %}" class="d-none">
    {% csrf_token %}
    <input type="hidden" name="promo_code" id="apply-promo-code">
  </form>
  <form id="clear-promo-form" method="post" action="{% url 'clear_promo' %}" class="d-none">
    {% csrf_token %}
  </form>
</div>
{% endblock %}

{% block postloadjs %}
{{ block.super }}
{{ stripe_public_key|json_script:"id_stripe_public_key" }}
{{ client_secret|json_script:"id_client_secret" }}
<script src="https://js.stripe.com/v3/"></script>
<script src="{% static 'js/stripe.js' %}"></script>
<script src="{% static 'js/promo.js' %}"></script>
{% endblock %}
